(function($) {
    'use strict';
    //Khai báo option global
    var block_01 = $('#block-01'),
        footer = $('.footer'),
        slider_home = $('#slider-home'),
        slider_popup = $('#slider-popup'),
        body = $("body"),
        map = $('[data-map="true"]'),
        box_filter = $('.box-filter'),
        box_find = $('#box-find'),
        loading = $("#loading");

    var checkDeviceMobile = function(){
        var is_mobile = false;
        if (Modernizr.mq('only all and (max-width: 767px)')) is_mobile = true;
        return is_mobile;
    };

    //Set chiều cao của block search
    var setHeightBlockSearch = function(){
        var h_window = $(window).innerHeight(),
            h_map = Math.abs(h_window - 108);
        if(checkDeviceMobile()){
            block_01.removeAttr('style');
        }else{
            block_01.css({height: h_window});
            map.css({height: h_map});
            slider_home.find('img').css({height: h_window});
        }
    };

    //Fix title homepage

    var fixTitleHomepage = function(){
        var titles = $('[data-scroll="true"]');
        //console.log(checkDeviceMobile());
        if(checkDeviceMobile()){
            titles.each(function(i) {
                var title = $(titles[i]),
                    next = titles[i + 1];
                title.scrollToFixed({
                    marginTop: $('.header-top').outerHeight(true),
                    limit: function() {
                        var limit = 0;
                        if (next) {
                            limit = $(next).offset().top - $(this).outerHeight(true) - 10;
                        } else {
                            limit = $('.footer').offset().top - $(this).outerHeight(true) - 10;
                        }
                        return limit;
                    },
                    baseClassName: 'is-fixed',
                    zIndex: 99
                });
            });
        }else{
            titles.removeAttr('style');
        }
    };

    //Check submenu
    var checkSubMenuMain = function(){
        $('.nav-main > ul > li,.nav-user > ul > li').each(function(){
            var has_sub = $(this).find('ul').length;
            if( has_sub > 0){
                $(this).addClass('has-sub');
            }
        });
    };

    //Style select option
    var styleFilter = function(){
        //var selects = $('[data-select="true"]');
        //selects.each(function(){
        //    var title = $(this).attr('title');
        //    if( $('option:selected', this).val() != '' ) title = $('option:selected',this).text();
        //    $(this)
        //        .css({zIndex : 10, opacity : 0})
        //        .after('<span class="span"><span>' + title + '</span></span>')
        //        .change(function(){
        //            var val = $('option:selected',this).text();
        //            $(this).next().html("<span>"+val+"</span>");
        //        })
        //});

        $(document).on('click','[data-action="filter"]',function(){
            var choice = $(this).data('choice'),
                reset = '.'+$(this).data('reset'),
                group = '.'+$(this).data('group'),
                content = $(this).parents(group).find(reset),
                target = $('[data-content="'+choice+'"]');
            content.hide().find('input').attr('disabled', 'disabled');
            target.show().find('input').removeAttr('disabled');
        });

        $(document).on('click','[data-action="all"]',function(){
            $(this).prop('checked', true).attr('disabled', 'disabled');
            $('[data-action="property"]').prop('checked',false).removeAttr('checked');
        });

        $(document).on('click','[data-action="property"]',function(){
            $(this).prop('checked', true);
            $('[data-action="all"]').prop('checked', false).removeAttr('disabled checked');
        });

        $(document).on('click','[data-action="more"]',function(e){
            e.preventDefault();
            var target = $(this).attr('href'),
                label = $(this).data('toggle-text'),
                text = $(this).text(),
                box_hide = $('.box-search, .footer, .box-list'),

                fix_filter = $('[data-action="fix"]');
            body.toggleClass('page-fixed');
            $(this)
                .data('toggle-text', text)
                .toggleClass('active')
                .text(label);
            $(target).fadeToggle(300, function(){
                box_hide.fadeToggle(100);
                $('html,body').animate({
                    scrollTop: 0
                }, 0);
            });
            fix_filter.scrollToFixed( {
                bottom: 0,
                limit: fix_filter.offset().top
            });
        });
        $(document).on('click', '[data-accordion="true"]', function(e){
            e.preventDefault();
            var reset = $('[data-accordion="true"]').parent('li').find('ul'),
                target = $(this).parent('li').find('ul'),
                that = $(this);
            if($(this).hasClass('active')){
                $(this).removeClass('active');
                target.slideUp(500);
            }else{
                $('[data-accordion="true"]').removeClass('active');
                reset.slideUp(0);
                $(this).addClass('active');
                target.slideDown(500, function(){
                    box_find.find('.data').animate({
                        scrollTop: Math.abs(target.offset().top - 90)
                    }, 300);
                });
            }
        });
        $(document).on('click', '[data-faq="true"]', function(e){
            e.preventDefault();
            var parent = '.' + $(this).data('parent'),
                content = '.' + $(this).data('target'),
                reset = $(parent).find(content),
                target = $(this).parents(parent).find(content);
            if($(this).hasClass('active')){
                $(this).removeClass('active');
                target.slideUp(500);
            }else{
                $('[data-faq="true"]').removeClass('active');
                reset.slideUp(0);
                $(this).addClass('active');
                target.slideDown(500);
            }
        });

        $(document).on('click','[data-action="radio"]', function(e){
            e.preventDefault();
            $('[data-action="radio"]').removeClass('active');
            var target = $(this).attr('href');
            $(this).addClass('active');
            $(target).trigger('click');
        });

        $(document).on('click','[data-action="check"]',function(e){
            e.preventDefault();
            var target = $(this).attr('href');
            $(this).toggleClass('active');
            $(target).trigger('click');
        });

        $(document).on('click','[data-filter="open"]',function(e){
            e.preventDefault();
            body.addClass('show-filter');
        });

        $(document).on('click','[data-filter="close"]',function(e){
            e.preventDefault();
            body.removeClass('show-filter');
        });

        $(document).on('click','[data-sort="show"]',function(e){
            e.preventDefault();
            body.addClass('show-sort');
        });

        $(document).on('click','[data-sort="close"]',function(e){
            e.preventDefault();
            body.removeClass('show-sort');
        });

        $(document).on('click','[data-action="sort"]',function(e){
            e.preventDefault();
            var sort = $(this).data('sort') ? $(this).data('sort') : '',
                order = $(this).data('order') ? $(this).data('order') : '';
            if(confirm('Write ajax get sort '+sort+' order by ' + order)){
                body.removeClass('show-sort');
            }
        });
    };


    var sliderBannerHomepage = function(){
        if(slider_home.length > 0 && slider_home.is(':visible')){
            slider_home.bxSlider({
                mode: 'fade',
                preloadImages: 'visible',
                auto: true,
                speed: 1000,
                autoHover: true,
                pause: 5000,
                pager: false,
                controls: false
            })
        }
    };

    //Fix vị trí của block search
    var onScrollBlockSearch = function(){
        $(window).scroll(function(){
            var window_pos = $(window).scrollTop(),
                footer_pos = $('.footer').length > 0 ? $('.footer').offset().top : 0,
                btn_request_post = $('[data-contact="detail"]'),
                search_pos = footer_pos - $(window).innerHeight();
            if(!checkDeviceMobile()){
                if(window_pos >= search_pos){
                    block_01.removeClass('is-fixed').css({top: search_pos - 84, position: 'relative'});
                    map.removeClass('is-fixed').css({top: search_pos + 42, position: 'relative'});
                }else{
                    block_01.addClass('is-fixed').css({top: 0, position: 'fixed'});
                    map.addClass('is-fixed').css({top: '108px', position: 'fixed'});
                }
                if(btn_request_post.length > 0){
                    if(window_pos >= btn_request_post.offset().top){
                        body.addClass('open-request');
                    }else{
                        body.removeClass('open-request');
                    }
                }
            }else{
                block_01.removeAttr('style');
                map.removeAttr('style');
            }
        });
    };

    //Click để thay đổi kiểu dữ liệu search
    var onChangeTypeSearch = function(){
        var search = $('[data-search="true"]');
        search.each(function(){
            if($(this).hasClass('active')){
                var target = $(this).attr('href'),
                    type = $(this).data('type');
                $(this).addClass('active');
                $(target).attr('value', type);
            }
        });
        search.on('click', function(e){
            e.preventDefault();
            var target = $(this).attr('href'),
                type = $(this).data('type');
            search.removeClass('active');
            $(this).addClass('active');
            $(target).attr('value', type);
        });
    };

    //Click để mở rộng menu footer
    var onMoreMenuFooter = function(){
        var more = $('[data-more="true"]');
        more.on('click', function(e) {
            e.preventDefault();
            var parent = '.' + $(this).data('parent'),
                element = $(this).parents(parent).find('.hidden');
            if ($(this).hasClass('active')) {
                element.slideUp(500);
                $(this)
                    .removeClass('active')
                    .text('More')
                    .attr('title', 'More');
            } else {
                element.slideDown(500);
                $(this)
                    .addClass('active')
                    .text('Less')
                    .attr('title', 'Less');
            }
        });
        $('[data-toggle="text"]').on('click', function(e){
            e.preventDefault();
            var group = '.'+$(this).data('group'),
                full = $(this).parents(group).find('.full'),
                label = $(this).data('toggle-text'),
                less = $(this).parents(group).find('.less');
            console.log(label);
            if($(this).hasClass('active')){
                full.hide();
                less.show();
                $(this)
                    .removeClass('active')
                    .text('More')
                    .attr('title', 'More');
            }else{
                less.hide();
                full.show();
                $(this)
                    .addClass('active')
                    .text(label)
                    .attr('title', label);
            }
        });
    };

    //Show/hide menu mobile
    var onMenuMobile = function(){
        $(document).on('click','[data-menu="true"]',function(e){
            e.preventDefault();
            $(this).toggleClass('active');
            var height_menu = $("#menu-left").find('.inner').height(),
                height_device = $(window).height();
            if(height_menu <= height_device) height_menu = height_device;
            if(body.hasClass("show-menu")){
                body.removeClass("show-menu").addClass('hide-menu');
                $("#wrapper").removeAttr("style");
            }else{
                body.removeClass('hide-menu').addClass("show-menu");
                $("#wrapper").css({height: height_menu});
            }
        });
        $(document).on('click','[data-overlay="true"]',function(e){
            e.preventDefault();
            if(body.hasClass("show-menu")){
                body.removeClass("show-menu").addClass('hide-menu');
                $("#wrapper").removeAttr("style");
                $('[data-menu="true"]').removeClass('active');
            }
        });

    };

    var showHideSavedHome = function(){
      $(document).on('click', '[data-open="true"]', function(e){
          e.preventDefault();
          if(body.hasClass('show-saved')){
            //Gọi ajax ở đây
          }else{
              body.addClass('show-saved');
          }
      });
      $(document).on('click', '[data-close="true"]', function(e){
          e.preventDefault();
          body.removeClass('show-saved');
      });
      $(document).on('click', '[data-tab="true"]', function(e){
          e.preventDefault();
          var target = $(this).attr('href'),
              content = '.'+$(this).data('content'),
              group = '.'+$(this).data('group');
          loading.show(300);
          $(this).parents(group).find('[data-tab="true"]').removeClass('active');
          $(this).addClass('active');
          $(group).find(content).hide();
          loading.fadeOut(300,function(){
              $(target).fadeIn(300);
          });

      });
    };

    var showPopupDetail = function(){
        var slider;
        if(slider_popup.length > 0){
            slider = slider_popup.bxSlider({
                //mode: 'fade',
                preloadImages: 'visible',
                auto: false,
                speed: 1000,
                autoHover: true,
                pause: 5000,
                pager: false,
                minSlides: 1,
                maxSlides: 1,
                controls: true,
                onSliderLoad: function(currentIndex){
                    $('#count').html(currentIndex + 1);
                },
                onSlideAfter: function($slideElement, oldIndex, newIndex){
                    $('#count').html(newIndex + 1);
                }
            });
        }
        $(document).on('click', '[data-popup="true"]', function(e){
            e.preventDefault();
            var target = $(this).attr('href'),
                goto = parseInt($(this).data('goto')) -1 || 0;
            $(target).fadeIn(500, function(){
                $('#total').html(slider.getSlideCount());
                slider.reloadSlider();
                slider.goToSlide(goto);
            })
        });
        $(document).on('click', '[data-hide="popup"]', function(e){
            e.preventDefault();
            var target = $(this).attr('href');
            $(target).fadeOut(500, function(){
                slider.destroySlider();
            })
        });
        $(document).on('click', '[data-toggle="contact"]', function(e){
            e.preventDefault();
            var target = $(this).attr('href'),
                text = $(this).text(),
                change = $(this).data('toggle-text');
            $(target).toggleClass('open');
            $(this).data('toggle-text', text).html('<i class="fa fa-angle-right"></i> ' + change).attr('title', change);
            slider.reloadSlider();
        });
        $(document).on('click', '#box-popup', function(e){
            e.preventDefault();
            if(e.target !== this) return;
            $(this).fadeOut(500, function(){
                slider.destroySlider();
            })
        });
    };

    var handleOptionProfile = function(){
        $(document).on('click', '[data-remove="avatar"]', function(e){
            e.preventDefault();
            var target = $(this).attr('href'),
                letter = '#' + $(this).data('show');
            $(this).fadeOut(500, function(){
                $(target).hide();
                $(letter).show();
            });
        });
        $(document).on('click', '[data-change="avatar"]', function(e){
            e.preventDefault();
            var target = $(this).attr('href');
            $(target).fadeIn(500);
        });
        $(document).on('click', '[data-close="avatar"]', function(e){
            e.preventDefault();
            var target = $(this).attr('href');
            $(target).fadeOut(500);
        });
        $(document).on('click', '[data-change="password"]', function(e){
            e.preventDefault();
            var target = '#' + $(this).data('target');
            $(this).parents('.control').fadeOut(500, function(){
                $(target)
                    .fadeIn(500)
                    .find('.form-control').removeAttr('disabled');
            });
        });
        $(document).on('click', '[data-check="toggle"]', function(e){
            e.preventDefault();
            var target = '#' + $(this).data('target');
            if($(this).hasClass('active')){
                $(this).removeClass('active');
                $(target).prop('checked', false);
            }else{
                $(this).addClass('active');
                $(target).prop('checked', true);
            }
        });
        $('[data-accordion="mobile"]').each(function(e){
            if($(this).hasClass('active')){
                var group = '.' + $(this).data('group'),
                    content = '.' + $(this).data('content'),
                    parent = $(this).parents(group),
                    target = parent.find(content);
                $(this).find('.toggle').text('SHOW DETAILS');
                parent.css('border-color', '#11c1f3');
                target.slideDown(500);

            }
        });
        $(document).on('click', '[data-accordion="mobile"]', function(e){
            e.preventDefault();
            var group = '.' + $(this).data('group'),
                content = '.' + $(this).data('content'),
                parent = $(this).parents(group),
                target = parent.find(content);
            if($(this).hasClass('active')){
                $(this).find('.toggle').text('HIDE DETAILS');
                $(this).removeClass('active');
                parent.removeAttr('style');
                target.slideUp(500);
            }else{
                $('[data-accordion="mobile"]').removeClass('active').find('.toggle').text('HIDE DETAILS');
                $(group)
                    .removeAttr('style')
                    .find(content).slideUp(500);
                $(this).find('.toggle').text('SHOW DETAILS');
                $(this).addClass('active');
                parent.css('border-color', '#11c1f3');
                target.slideDown(500);
            }
        });
        $(document).on('click', '[data-accordion="nav"]', function(e){
            e.preventDefault();
            var index = $(this).data('index'),
                group = '.' + $(this).data('group'),
                item = '.' + $(this).data('target'),
                target = $(this).parents(group).find(item).eq(index),
                accordion = target.find('[data-accordion="mobile"]');
            if(accordion.hasClass('active')){
                $('html,body').animate({
                    scrollTop: target.offset().top
                }, 500);
            }else{
                $('[data-accordion="mobile"]').removeClass('active').find('.toggle').text('HIDE DETAILS');
                $(item)
                    .removeAttr('style')
                    .find('.data').slideUp(500);
                accordion.find('.toggle').text('SHOW DETAILS');
                accordion.addClass('active');
                target.css('border-color', '#11c1f3');
                target.find('.data').slideDown(500, function(){
                    $('html,body').animate({
                        scrollTop: target.offset().top
                    }, 500);
                });
            }
        });

    };

    var validateLoginAndRegister = function(){
        $(document).on('click', '[data-action="login"]', function(e){
            e.preventDefault();
            var target = $(this).attr('href');
            $(target).fadeIn(500);
        });
        $(document).on('click', '#box-login', function(e){
            if(e.target !== this) return;
            $(this).fadeOut(500);
        });
        $(document).on('click', '[data-login="close"]', function(e){
            e.preventDefault();
            var target = $(this).attr('href');
            $(target).fadeOut(500);
        });
        $("#form-login").validate({
            rules: {
                email: {
                    required: true,
                    email: true
                }
            },
            messages: {
                email: {
                    required: 'Please complete this field',
                    email: 'Please enter a valid email'
                }
            }
        });
        $('.form-mobile').each(function(){
            $(this).validate({
                rules: {
                    sms_phone1: {
                        required: true,
                        number: true,
                        maxlength: 3
                    },
                    sms_phone2: {
                        required: true,
                        number: true,
                        maxlength: 3
                    },
                    sms_phone3: {
                        required: true,
                        number: true,
                        maxlength: 4
                    }
                },
                messages: {
                    sms_phone1: {
                        required: 'Please complete this field',
                        number:  'Phone number must be a number',
                        maxlength: 'Phone number at least 3 characters'
                    },
                    sms_phone2: {
                        required: 'Please complete this field',
                        number:  'Phone number must be a number',
                        maxlength: 'Phone number at least 3 characters'
                    },
                    sms_phone3: {
                        required: 'Please complete this field',
                        number:  'Phone number must be a number',
                        maxlength: 'Phone number at least 4 characters'
                    }
                }
            });
        });
        $("#form-register").validate({
            rules: {
                name: {
                    required: true
                },
                email: {
                    required: true,
                    email: true
                },
                password: {
                    required: true,
                    minlength: 5,
                    maxlength: 15
                },
                re_password: {
                    required : true,
                    equalTo  : '#password',
                    minlength: 5,
                    maxlength: 15
                },
                phone: {
                    required: true,
                    number: true,
                    minlength: 10,
                    maxlength: 12
                },
                location: {
                    required: true
                },
                status: {
                    required: true
                }
            },
            messages: {
                name: {
                    required: 'Please complete this field'
                },
                email: {
                    required: 'Please complete this field',
                    email: 'Please enter a valid email'
                },
                password: {
                    required: 'Please complete this field',
                    minlength: 'Password at least 5 characters',
                    maxlength: 'Password maximum 15 characters'
                },
                re_password: {
                    required: 'Please complete this field',
                    equalTo  : 'Password do not match',
                    minlength: 'Password at least 5 characters',
                    maxlength: 'Password maximum 15 characters'
                },
                phone: {
                    required: 'Please complete this field',
                    number:  'Phone number must be a number',
                    minlength: 'Phone number at least 10 characters',
                    maxlength: 'Phone number at least 12 characters'
                },
                location: {
                    required: 'Please complete this field'
                },
                status: {
                    required: 'Please complete this field'
                }
            }
        });
    };
    /* Advance search mobile function */
    var advanceSearchMobile = function () {
        $('[data-ui="slider"]').each(function() {
            var target = '#' + $(this).data('target'),
                min = parseInt($(target).attr('min')),
                max = parseInt($(target).attr('max')),
                value = ($(target).val() != '') ? parseInt($(target).val()) : 0;
            $(this).empty().slider({
                min: min,
                max: max,
                step: 1,
                value: value,
                slide: function( event, ui ) {
                    $(target).val(ui.value);
                }
            });
        });

        $('[data-ui="input"]').on('change', function () {
            var target = '#' + $(this).data('target'),
                value = parseInt($(this).val()),
                max = parseInt($(this).attr('max')),
                min = parseInt($(this).attr('min'));
            if(value > max){
                value = max;
                $(this).val(value);
            }
            if(value < min){
                value = min;
                $(this).val(value);
            }
            $(target).slider( "value", value);
        });
        
        
    };
    /* Advance search pc function */
    var advanceSearchPc = function(){
        var form_searchh = $("#form-search");
        $(document).on('click','[data-search="advance"]',function(e){
            var choice = '#' + $(this).data('choice'),
                reset = '.'+$(this).data('reset'),
                group = '.'+$(this).data('group'),
                content = $(group).find(reset),
                toggle_filter = $('#common_filters');
            content.find('input').attr('disabled', 'disabled');
            content.find('select').attr('disabled', 'disabled');
            content.hide();
            $(choice).show();
            if(choice === '#content_buy'){
                $('#nav_buy').removeClass('hidden');
                toggle_filter.addClass('hidden');
                $('[data-option="tab"]').each(function(){
                    var parent = $(this).parent(),
                        target = '#' + $(this).data('target'),
                        filter = $(this).data('filter');
                    if(parent.hasClass('active')){
                        $(target).removeClass('hidden');
                        $(target).find('select').removeAttr('disabled');
                        $(target).find('input').removeAttr('disabled');
                        if(filter){
                            toggle_filter.removeClass('hidden');
                            toggle_filter.find('select').removeAttr('disabled');
                            toggle_filter.find('input').removeAttr('disabled');
                        }
                    }else{
                        $(target).addClass('hidden');

                    }
                });
            }else{
                $('#nav_buy').addClass('hidden');
                $(choice).find('select').removeAttr('disabled');
                $(choice).find('input').removeAttr('disabled');
            }
        });

        $(document).on('click','[data-option="tab"]',function(e){
            e.preventDefault();
            var target = '#' + $(this).data('target'),
                reset = '.'+$(this).data('reset'),
                group = '#'+$(this).data('group'),
                content = $(group).find(reset),
                toggle_filter = $('#common_filters'),
                filter = $(this).data('filter'),
                parent = $(this).parent();
            $(this).parents('ul').find('li').removeClass('active');
            content.find('input').attr('disabled', 'disabled');
            content.find('select').attr('disabled', 'disabled');
            content.addClass('hidden');
            parent.addClass('active');
            $(target).removeClass('hidden');
            $(target).find('select').removeAttr('disabled');
            $(target).find('input').removeAttr('disabled');
            if(filter){
                toggle_filter.removeClass('hidden');
                toggle_filter.find('select').removeAttr('disabled');
                toggle_filter.find('input').removeAttr('disabled');
            }else{
                toggle_filter.addClass('hidden');
                toggle_filter.find('input').attr('disabled', 'disabled');
                toggle_filter.find('input').attr('disabled', 'disabled');
            }
        });

        $(document).on('click', '[data-submit="true"]', function(e){
            e.preventDefault();
            form_searchh.submit();
        });

        $(document).on('click', '[data-action="update"]', function(e){
            e.preventDefault();
            var obj = $(this).parents('.item').find('.update');
            obj.slideToggle(500);
        });

        form_searchh.validate({
            rules: {
                city: {
                    required: true
                },
                zip: {
                    required: true
                },
                nh: {
                    required: true
                },
                address_street_number: {
                    required: true
                },
                address_street: {
                    required: true
                },
                address_city: {
                    required: true
                },
                county: {
                    required: true
                },
                school: {
                    required: true
                },
                mls: {
                    required: true
                },
                mls_city: {
                    required: true
                },
                price_city: {
                    required: true
                }
            },
            messages: {
                city: {
                    required: 'Please complete this field'
                },
                zip: {
                    required: 'Please complete this field'
                },
                nh: {
                    required: 'Please complete this field'
                },
                address_street_number: {
                    required: 'Please complete this field'
                },
                address_street: {
                    required: 'Please complete this field'
                },
                address_city: {
                    required: 'Please complete this field'
                },
                county: {
                    required: 'Please complete this field'
                },
                school: {
                    required: 'Please complete this field'
                },
                mls: {
                    required: 'Please complete this field'
                },
                mls_city: {
                    required: 'Please complete this field'
                },
                price_city: {
                    required: 'Please complete this field'
                }
            }
        });
    };
    //Window ready
    jQuery(document).ready(function(){
        onChangeTypeSearch();
        onMoreMenuFooter();
        setHeightBlockSearch();
        onScrollBlockSearch();
        sliderBannerHomepage();
        checkSubMenuMain();
        onMenuMobile();
        fixTitleHomepage();
        showHideSavedHome();
        styleFilter();
        showPopupDetail();
        //Slider banner at homepage
        validateLoginAndRegister();
        //console.log(checkDeviceMobile());
        /*page profile*/
        handleOptionProfile();
        /**/
        advanceSearchPc();
        advanceSearchMobile();
    });

    //Window resize
    $(window).resize(function(){
        setHeightBlockSearch();
        onScrollBlockSearch();
        fixTitleHomepage();
    });

    //Window loaded
    $(window).load(function(){
    });

})(jQuery);
